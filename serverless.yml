service: acs-user-sync

# You can pin your service to only deploy with a specific Serverless version
# Check out our docs for more details
# frameworkVersion: "=X.X.X"

custom:
  stage: ${opt:stage, self:provider.stage}

provider:
  name: aws
  runtime: nodejs6.10
  memorySize: 128
  timeout: 20
  stage: "dev"
  region: "us-west-2"
  environment:
    CONFIG_BUCKET: "${file(./resources.yml):CONFIG_BUCKET}" 
    CONFIG_KEY: "${file(./resources.yml):${self:custom.stage}.CONFIG_KEY}"
    authorizedIps: "${file(./resources.yml):${self:custom.stage}.authorizedIps}"
    awsRegion: "${file(./resources.yml):awsRegion}"
    emailDomain: "${file(./resources.yml):emailDomain}"
    gwsKey: "${file(./resources.yml):gwsKey}"
    sqsQueueName: "${file(./resources.yml):sqsQueueName}"
    usernameKey: "${file(./resources.yml):usernameKey}"
    ignoredGroups: "${file(./resources.yml):ignoredGroups}"
    ignoredGroupPrefixes: "${file(./resources.yml):ignoredGroupPrefixes}"

  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "logs:CreateLogGroup"
        - "logs:CreateLogStream"
        - "logs:PutLogEvents"
      Resource: "arn:aws:logs:*:*:*"
    - Effect: "Allow"
      Action:
        - "kms:Decrypt"
      Resource: ${file(./resources.yml):kmsKeys}
    - Effect: "Allow"
      Action:
        - "s3:GetObject"
      Resource: ${file(./resources.yml):s3Buckets}
    - Effect: "Allow"
      Action:
        - sqs:DeleteMessage
        - sqs:GetQueueUrl
        - sqs:ReceiveMessage
      Resource: ${file(./resources.yml):${self:custom.stage}.sqs}

plugins:
  - serverless-webpack
  - serverless-offline

functions:
  sync-user:
    handler: src/main/node/handler.syncUser
    events:
      - http:
          path: acs-user-sync
          method: any 
          integration: lambda-proxy
          request:
            parameters:
              querystrings:
                redirectPath: false
    memorySize: 256
    timeout: 20s
    vpc:
      securityGroupIds:
        - 'Ref': AcsUserSyncLambdaSecurityGroup
      subnetIds: ${file(./resources.yml):${self:custom.stage}.subnetIds}

  cron:
    handler: src/main/node/handler.syncGroup
    events:
      - schedule: rate(10 minutes)
        enabled: true
    memorySize: 256
    timeout: 20s
    vpc:
      securityGroupIds:
        - 'Ref': AcsUserSyncLambdaSecurityGroup
      subnetIds: ${file(./resources.yml):${self:custom.stage}.subnetIds}

resources:
  Resources:
    AcsUserSyncLambdaSecurityGroup:
      Type: "AWS::EC2::SecurityGroup"
      Properties: ${file(./resources.yml):AcsUserSyncLambdaSecurityGroupProperties}

package:
  exclude:
    - node_modules/aws-sdk/**
    - node_modules/aws-sdk-mock/**
    - node_modules/serverless/**
    - src/main/resources/**
    - src/main/**/*.spec.ts
